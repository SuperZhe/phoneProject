<!doctype html>
<!--[if lt IE 7]> <html class="ie6 oldie"> <![endif]-->
<!--[if IE 7]>    <html class="ie7 oldie"> <![endif]-->
<!--[if IE 8]>    <html class="ie8 oldie"> <![endif]-->
<!--[if gt IE 8]><!-->
<html class="">
<!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>感动2016员工投选</title>
  <link href="css/boilerplate.css" rel="stylesheet" type="text/css">
  <link href="css/style.css" rel="stylesheet" type="text/css">
  <link href="css/sweet-alert.css" rel="stylesheet" type="text/css">
  <link rel="shortcut icon" href="favicon.ico" />
<!--[if lt IE 9]>
<script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
<![endif]-->
<script src="js/respond.min.js"></script>
<script src="js/sweet-alert.min.js"></script>
<script src="js/jquery.min.js"></script>
</head>
<body style="background:#c30d23">


  <div id="content_title1" class="fluid clearfix" >
    <div class="content_title">
    	参与投票
    </div>
  </div>
  <div class="clearfix"></div>
<div id="content_list" class="gridContainer clearfix bounceInDown animated">
  <div class="content_list_li">
    <div class="content_list_li_left">
      <span class="imgbox"><img src="images/touch001.jpg" ></span>
      <div class="content_list_li_right_li"><strong>参选编号：</strong><span class="userid"></span></div>
      <div class="content_list_li_right_li"><strong>所在部门：</strong><span class="userbumen"></span></div>
      <div class="content_list_li_right_li"><strong>参选人员：</strong><span class="pName"></span></div>
      <div class="content_list_li_right_li_a">
        <a id="001" class="btn to t1" ></a>
        <!-- <a class="btn to on" >已获得<span></span>票</a> -->
        <a class="btn to on" >Thank You</a>
      </div>
    </div>
    <div class="content_list_li_right">
      <div class="text">
        <b>个人简介</b>
        <p></p>
      </div>
    </div>
    <div class="clearfix"></div>
  </div>
</div>
<div id="content_list" class="gridContainer clearfix bounceInDown animated">
  <div class="content_list_li">
    <div class="content_list_li_left">
      <span class="imgbox"><img src="images/touch002.jpg" ></span>
      <div class="content_list_li_right_li"><strong>参选编号：</strong><span class="userid"></span></div>
      <div class="content_list_li_right_li"><strong>所在部门：</strong><span class="userbumen"></span></div>
      <div class="content_list_li_right_li"><strong>参选人员：</strong><span class="pName"></span></div>
      <div class="content_list_li_right_li_a">
        <a id="002" class="btn to t1" ></a>
        <!-- <a class="btn to on" >已获得<span></span>票</a> -->
        <a class="btn to on" >Thank You</a>
      </div>
    </div>
    <div class="content_list_li_right">
      <div class="text">
        <b>事迹简介</b>
        <p></p>
      </div>
    </div>
    <div class="clearfix"></div>
  </div>
</div>
<div id="content_list" class="gridContainer clearfix bounceInDown animated">
  <div class="content_list_li">
    <div class="content_list_li_left">
      <span class="imgbox"><img src="images/touch003.jpg" ></span>
      <div class="content_list_li_right_li"><strong>参选编号：</strong><span class="userid"></span></div>
      <div class="content_list_li_right_li"><strong>所在部门：</strong><span class="userbumen"></span></div>
      <div class="content_list_li_right_li"><strong>参选人员：</strong><span class="pName"></span></div>
      <div class="content_list_li_right_li_a">
        <a id="003" class="btn to t1" ></a>
        <!-- <a class="btn to on" >已获得<span></span>票</a> -->
        <a class="btn to on" >Thank You</a>
      </div>
    </div>
    <div class="content_list_li_right">
      <div class="text">
        <b>事迹简介</b>
        <p></p>
      </div>
    </div>
    <div class="clearfix"></div>
  </div>
</div>
<div id="content_list" class="gridContainer clearfix bounceInDown animated">
  <div class="content_list_li">
    <div class="content_list_li_left">
      <span class="imgbox"><img src="images/touch004.jpg" ></span>
      <div class="content_list_li_right_li"><strong>参选编号：</strong><span class="userid"></span></div>
      <div class="content_list_li_right_li"><strong>所在部门：</strong><span class="userbumen"></span></div>
      <div class="content_list_li_right_li"><strong>参选人员：</strong><span class="pName"></span></div>
      <div class="content_list_li_right_li_a">
        <a id="004" class="btn to t1" ></a>
        <!-- <a class="btn to on" >已获得<span></span>票</a> -->
        <a class="btn to on" >Thank You</a>
      </div>
    </div>
    <div class="content_list_li_right">
      <div class="text">
        <b>事迹简介</b>
        <p></p>
      </div>
    </div>
    <div class="clearfix"></div>
  </div>
</div>
<div id="content_list" class="gridContainer clearfix bounceInDown animated">
  <div class="content_list_li">
    <div class="content_list_li_left">
      <span class="imgbox"><img src="images/touch005.jpg" ></span>
      <div class="content_list_li_right_li"><strong>参选编号：</strong><span class="userid"></span></div>
      <div class="content_list_li_right_li"><strong>所在部门：</strong><span class="userbumen"></span></div>
      <div class="content_list_li_right_li"><strong>参选人员：</strong><span class="pName"></span></div>
      <div class="content_list_li_right_li_a">
        <a id="005" class="btn to t1" ></a>
        <!-- <a class="btn to on" >已获得<span></span>票</a> -->
        <a class="btn to on" >Thank You</a>
      </div>
    </div>
    <div class="content_list_li_right">
      <div class="text">
        <b>事迹简介</b>
        <p></p>
      </div>
    </div>
    <div class="clearfix"></div>
  </div>
</div>
<div id="content_list" class="gridContainer clearfix bounceInDown animated">
  <div class="content_list_li">
    <div class="content_list_li_left">
      <span class="imgbox"><img src="images/touch006.jpg" ></span>
      <div class="content_list_li_right_li"><strong>参选编号：</strong><span class="userid"></span></div>
      <div class="content_list_li_right_li"><strong>所在部门：</strong><span class="userbumen"></span></div>
      <div class="content_list_li_right_li"><strong>参选人员：</strong><span class="pName"></span></div>
      <div class="content_list_li_right_li_a">
        <a id="006" class="btn to t1" ></a>
        <!-- <a class="btn to on" >已获得<span></span>票</a> -->
        <a class="btn to on" >Thank You</a>
      </div>
    </div>
    <div class="content_list_li_right">
      <div class="text">
        <b>事迹简介</b>
        <p></p>
      </div>
    </div>
    <div class="clearfix"></div>
  </div>
</div>
<div id="content_list" class="gridContainer clearfix bounceInDown animated">
  <div class="content_list_li">
    <div class="content_list_li_left">
      <span class="imgbox"><img src="images/touch007.jpg" ></span>
      <div class="content_list_li_right_li"><strong>参选编号：</strong><span class="userid"></span></div>
      <div class="content_list_li_right_li"><strong>所在部门：</strong><span class="userbumen"></span></div>
      <div class="content_list_li_right_li"><strong>参选人员：</strong><span class="pName"></span></div>
      <div class="content_list_li_right_li_a">
        <a id="007" class="btn to t1" ></a>
        <!-- <a class="btn to on" >已获得<span></span>票</a> -->
        <a class="btn to on" >Thank You</a>
      </div>
    </div>
    <div class="content_list_li_right">
      <div class="text">
        <b>事迹简介</b>
        <p></p>
      </div>
    </div>
    <div class="clearfix"></div>
  </div>
</div>
<div id="content_list" class="gridContainer clearfix bounceInDown animated">
  <div class="content_list_li">
    <div class="content_list_li_left">
      <span class="imgbox"><img src="images/touch008.jpg" ></span>
      <div class="content_list_li_right_li"><strong>参选编号：</strong><span class="userid"></span></div>
      <div class="content_list_li_right_li"><strong>所在部门：</strong><span class="userbumen"></span></div>
      <div class="content_list_li_right_li"><strong>参选人员：</strong><span class="pName"></span></div>
      <div class="content_list_li_right_li_a">
        <a id="008" class="btn to t1" ></a>
        <!-- <a class="btn to on" >已获得<span></span>票</a> -->
        <a class="btn to on" >Thank You</a>
      </div>
    </div>
    <div class="content_list_li_right">
      <div class="text">
        <b>事迹简介</b>
        <p></p>
      </div>
    </div>
    <div class="clearfix"></div>
  </div>
</div>
<div id="content_list" class="gridContainer clearfix bounceInDown animated">
  <div class="content_list_li">
    <div class="content_list_li_left">
      <span class="imgbox"><img src="images/touch009.jpg" ></span>
      <div class="content_list_li_right_li"><strong>参选编号：</strong><span class="userid"></span></div>
      <div class="content_list_li_right_li"><strong>所在部门：</strong><span class="userbumen"></span></div>
      <div class="content_list_li_right_li"><strong>参选人员：</strong><span class="pName"></span></div>
      <div class="content_list_li_right_li_a">
        <a id="009" class="btn to t1" ></a>
        <!-- <a class="btn to on" >已获得<span></span>票</a> -->
        <a class="btn to on" >Thank You</a>
      </div>
    </div>
    <div class="content_list_li_right">
      <div class="text">
        <b>事迹简介</b>
        <p></p>
      </div>
    </div>
    <div class="clearfix"></div>
  </div>
</div>
<div id="content_list" class="gridContainer clearfix bounceInDown animated">
  <div class="content_list_li">
    <div class="content_list_li_left">
      <span class="imgbox"><img src="images/touch010.jpg" ></span>
      <div class="content_list_li_right_li"><strong>参选编号：</strong><span class="userid"></span></div>
      <div class="content_list_li_right_li"><strong>所在部门：</strong><span class="userbumen"></span></div>
      <div class="content_list_li_right_li"><strong>参选人员：</strong><span class="pName"></span></div>
      <div class="content_list_li_right_li_a">
        <a id="010" class="btn to t1" ></a>
        <!-- <a class="btn to on" >已获得<span></span>票</a> -->
        <a class="btn to on" >Thank You</a>
      </div>
    </div>
    <div class="content_list_li_right">
      <div class="text">
        <b>事迹简介</b>
        <p></p>
      </div>
    </div>
    <div class="clearfix"></div>
  </div>
</div>
<div id="content_list" class="gridContainer clearfix bounceInDown animated">
  <div class="content_list_li">
    <div class="content_list_li_left">
      <span class="imgbox"><img src="images/touch011.png" ></span>
      <div class="content_list_li_right_li"><strong>参选编号：</strong><span class="userid"></span></div>
      <div class="content_list_li_right_li"><strong>所在部门：</strong><span class="userbumen"></span></div>
      <div class="content_list_li_right_li"><strong>参选人员：</strong><span class="pName"></span></div>
      <div class="content_list_li_right_li_a">
        <a id="011" class="btn to t1" ></a>
        <!-- <a class="btn to on" >已获得<span></span>票</a> -->
        <a class="btn to on" >Thank You</a>
      </div>
    </div>
    <div class="content_list_li_right">
      <div class="text">
        <b>事迹简介</b>
        <p></p>
      </div>
    </div>
    <div class="clearfix"></div>
  </div>
</div>
<div id="content_list" class="gridContainer clearfix bounceInDown animated">
  <div class="content_list_li">
    <div class="content_list_li_left">
      <span class="imgbox"><img src="images/touch012.jpg" ></span>
      <div class="content_list_li_right_li"><strong>参选编号：</strong><span class="userid"></span></div>
      <div class="content_list_li_right_li"><strong>所在部门：</strong><span class="userbumen"></span></div>
      <div class="content_list_li_right_li"><strong>参选人员：</strong><span class="pName"></span></div>
      <div class="content_list_li_right_li_a">
        <a id="012" class="btn to t1" ></a>
        <!-- <a class="btn to on" >已获得<span></span>票</a> -->
        <a class="btn to on" >Thank You</a>
      </div>
    </div>
    <div class="content_list_li_right">
      <div class="text">
        <b>事迹简介</b>
        <p></p>
      </div>
    </div>
    <div class="clearfix"></div>
  </div>
</div>
<div id="content_list" class="gridContainer clearfix bounceInDown animated">
  <div class="content_list_li">
    <div class="content_list_li_left">
      <span class="imgbox"><img src="images/touch013.jpg" ></span>
      <div class="content_list_li_right_li"><strong>参选编号：</strong><span class="userid"></span></div>
      <div class="content_list_li_right_li"><strong>所在部门：</strong><span class="userbumen"></span></div>
      <div class="content_list_li_right_li"><strong>参选人员：</strong><span class="pName"></span></div>
      <div class="content_list_li_right_li_a">
        <a id="013" class="btn to t1" ></a>
        <!-- <a class="btn to on" >已获得<span></span>票</a> -->
        <a class="btn to on" >Thank You</a>
      </div>
    </div>
    <div class="content_list_li_right">
      <div class="text">
        <b>事迹简介</b>
        <p></p>
      </div>
    </div>
    <div class="clearfix"></div>
  </div>
</div>
<div class="clearfix" style="height:2em;"></div>
<footer>
  <a href="index.html" class="go btn" style="z-index:9999;">点击返回主页面</a>
</footer>
<script src="js/bmob-min.js"></script>
<script>
       //添加cookie
    function addCookie(name,cookievalue,time) {
        if (name != "" && cookievalue != "" &&  time != "") {
            if (isNaN(time) == false){
                var expires = new Date();
                expires.setTime(expires.getTime() + time * 1000);
                document.cookie = name + '=' + escape(cookievalue) + ';expires=' + expires.toGMTString();
            }
        }
    }
    //获取cookie
    function getCookie(cookieName) {
        var cookieString = document.cookie;
        var start = cookieString.indexOf(cookieName + '=');
        if (start == -1)
            return null;
        start += cookieName.length + 1;
        var end = cookieString.indexOf(';', start);
        if (end == -1) return unescape(cookieString.substring(start));
        return unescape(cookieString.substring(start, end));
    }
    //云端存储
    Bmob.initialize("daaefcca72c2225e29f65c9a80bb85e5","f0bb38af70958b0027c159f5f8211cf8");
    var ZanCount = Bmob.Object.extend("staff");
    var queryinit = new Bmob.Query(ZanCount);
    // 查询所有数据
    queryinit.find({
      success: function(results) {
        //results.ascending("result.get(userid")
        console.log(results);
        //对查询到的数组对象进行排序
         var results = results.sort(  
                function(a, b)  
                {  
                    if(a.get('userid') < b.get('userid')) return -1;  
                    if(a.get('userid') > b.get('userid')) return 1;  
                    return 0;  
                }  
            );  
        console.log("共查询到 " + results.length + " 条记录");
        // 循环处理查询到的数据
        var countArr = [];
        for (var i = 0; i < results.length; i++) {
          var object = results[i];
          var projectId = object.get('userid')
           var countNum = object.get('count');
           $(".content_list_li").eq(i).find(".content_list_li_left .userid").html(projectId);
           $(".content_list_li").eq(i).find(".content_list_li_left .userbumen").html(object.get('pbumen'));
           $(".content_list_li").eq(i).find(".content_list_li_left .pName").html(object.get('pName'));
           $(".content_list_li").eq(i).find(".content_list_li_right .text p").html(object.get('detail'));
          $(".content_list_li>.content_list_li_left>.content_list_li_right_li_a>.on span").eq(i).html(countNum);
           if(!getCookie(String(projectId))){ //
                console.log("未点击过");
                 $(".content_list_li_right_li_a>.t1").eq(i).html("投我吧").css("background-color","#ff7700");
            }else{
                 $(".content_list_li_right_li_a>.t1").eq(i).html("已投票").css("background-color","#ccc");
                console.log("已点击过");
            }

        };
       
      },
      error: function(error) {
        alert("查询失败: " + error.code + " " + error.message);
      }
    });
</script>
<script type="text/javascript">
 

  $(".content_list_li_right_li_a>.t1").click(function(event) {
       
       //改变样式
       $(this).css("background-color","#ccc").html("已投票");
       var button = $(this);
       var btnId = button.attr("id");
       console.log(btnId);
       var objId;
       var objcount;
       var count;
       var clickcount;
       //cookie 判断cookie是否为空,如果是空,弹出投票成功的弹窗,如果非空即投过票
            console.log( !getCookie(String(btnId)) );
            console.log( getCookie(String(btnId)) );
            if(!getCookie(String(btnId))){ //
                swal('投票成功!', '非常感谢,么么哒！', 'success');
                addCookie(btnId,"1","1000000000");
                console.log("未点击过");
            }else{
                console.log("已点击过");
                  // swal('投票失败!', '每个节目您只有一次投票机会！', 'error');
                  $(this).html("已投票").css("background-color","#ccc");
                console.log("已点击过");
                 return;
            }

       var queryZan = new Bmob.Query(ZanCount);
        queryZan.equalTo("userid", btnId);
        console.log("btnId---" + btnId);
        queryZan.first({
            success: function(object) {
              console.log(object);
            // 查询成功
            objId = object.id;
            objcount = object.get("count");
            console.log("query object success, objectId  " + objId+  objcount);
            // console.log(Number(objcount));
            // var count =  Number(objcount);
            //  count++;
            //  objcount = String(count);
            // console.log(objcount);
            },
              error: function(error) {
                console.log("查询失败: " + error.code + " " + error.message);
              }
        });
        console.log("查询到的objectId  " + objId);
        queryZan.get(objId,{
            success:function(obj){
               objcount++;
               var countNum = Number(objcount);
               console.log(countNum);
               obj.set("count",countNum);
               obj.save(null,{
                success:function(objUpdate){
                    console.log("creat object success");
                    button.siblings('a').find('span').text(countNum);
                },
                error:function(model,error){
                    console.log("修改失败: " + error.code + " " + error.message);
                }
               })
            },
            error: function(object, error) {
                console.log("修改失败: " + error.code + " " + error.message);
            }
        })
    });
</script>
      </body>
      </html>
